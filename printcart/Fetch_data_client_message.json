{
  "name": "Fetch data client message",
  "nodes": [
    {
      "parameters": {},
      "id": "03bc8f7a-6075-4253-986c-c57437a4964d",
      "name": "When clicking ‘Test workflow’",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        680,
        1000
      ]
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v21.0/{{ $json.data[0].id }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "fields",
              "value": "messages{id,message,from,to}"
            },
            {
              "name": "access_token",
              "value": "EAAQEYCcZCVQ0BOzY6wqcnJVxVynZBLbm5hhScnbluyUZAfGFji6VNyf3R8Jvy0zDoypmZBIsFhZCU1tBRPjlIwS1FWFDeDSqzSa2AGdyDqbTN7MP88cbSiP9CPXY1gmM4EJzHWsO64oZBZA8bimm01LQ3p0n5jCpZCzhjlESwV0JGm16ocyrZBLHu9FSh5wYe08wZD"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "ecc5157a-786e-4722-8dd6-254bbf48734c",
      "name": "Get Detail list Chat User2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1040,
        180
      ]
    },
    {
      "parameters": {
        "url": "https://graph.facebook.com/v21.0/112710510078308/conversations",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "platform",
              "value": "MESSENGER"
            },
            {
              "name": "user_id",
              "value": "={{ $json.body.senderId }}"
            },
            {
              "name": "access_token",
              "value": "EAAQEYCcZCVQ0BO3pe1XAVU6TdQireGrFhQuA0VNvdVVQZA7sTcCOxHsLgNTGHDqfVpEJHZAM6RgUC5Hzz2kGeiNcGZBzP1x8iSi1eqakD3UgOF2BlwQIncNQAavaNc28uVAy5XbbWwNukbwVrDB3JBQRbZBxxpummuVNaQLjKRurdcYPY9LF9iSoWcsxziaoZD"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "19f00c3e-800f-43a0-8534-1b5610d8bee8",
      "name": "HTTP Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        840,
        180
      ]
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v21.0/{{ $json.messages.data[0].id }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "access_token",
              "value": "EAAQEYCcZCVQ0BOzY6wqcnJVxVynZBLbm5hhScnbluyUZAfGFji6VNyf3R8Jvy0zDoypmZBIsFhZCU1tBRPjlIwS1FWFDeDSqzSa2AGdyDqbTN7MP88cbSiP9CPXY1gmM4EJzHWsO64oZBZA8bimm01LQ3p0n5jCpZCzhjlESwV0JGm16ocyrZBLHu9FSh5wYe08wZD"
            },
            {
              "name": "fields",
              "value": "id,message,from,to,created_time"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "83c1831a-1686-43cf-b53e-33788199b00c",
      "name": "Get Detail Last list Chat User",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1240,
        180
      ]
    },
    {
      "parameters": {
        "url": "https://graph.facebook.com/v21.0/112710510078308/conversations",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "platform",
              "value": "MESSENGER"
            },
            {
              "name": "access_token",
              "value": "EAAQEYCcZCVQ0BO3pe1XAVU6TdQireGrFhQuA0VNvdVVQZA7sTcCOxHsLgNTGHDqfVpEJHZAM6RgUC5Hzz2kGeiNcGZBzP1x8iSi1eqakD3UgOF2BlwQIncNQAavaNc28uVAy5XbbWwNukbwVrDB3JBQRbZBxxpummuVNaQLjKRurdcYPY9LF9iSoWcsxziaoZD"
            },
            {
              "name": "after",
              "value": "={{ $json.next }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "89030fac-78d0-4b9b-a251-28cd8a91649b",
      "name": "Get All conversation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        500
      ]
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v21.0/{{ $json.conversation_id }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "fields",
              "value": "participants{id}"
            },
            {
              "name": "access_token",
              "value": "EAAQEYCcZCVQ0BOzY6wqcnJVxVynZBLbm5hhScnbluyUZAfGFji6VNyf3R8Jvy0zDoypmZBIsFhZCU1tBRPjlIwS1FWFDeDSqzSa2AGdyDqbTN7MP88cbSiP9CPXY1gmM4EJzHWsO64oZBZA8bimm01LQ3p0n5jCpZCzhjlESwV0JGm16ocyrZBLHu9FSh5wYe08wZD"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "2a45c67a-325e-47ca-964c-d456f7bc0089",
      "name": "HTTP Request1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1380,
        480
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "data",
        "options": {}
      },
      "id": "40acaf6a-e581-46be-accf-358d9479b4b7",
      "name": "Split Out",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        380,
        140
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.next }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "24248dea-b996-4b73-aa83-0ca694e6a296",
      "name": "IF8",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        540,
        620
      ]
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  const after = item?.json?.paging?.next;\n  console.log('after', after);\n\n  if (after && after.includes(\"after=\")) {\n    const valueAfterEqual = after.split(\"after=\")[1];\n    item.json.next = valueAfterEqual;\n\n    // Kiểm tra dữ liệu trả về từ Get Id Store\n    // if ($node[\"Get Id Store3\"]?.json?.data && $node[\"Get Id Store3\"].json.data.length > 0) {\n    //   item.json.conver = $node[\"Get Id Store3\"]?.json?.data[0]?.id; // Lấy ID từ data[0]\n    // } else {\n    //   console.log('No data found in Get Id Store');\n    // }\n  } else {\n    item.json.next = null; // Nếu không có 'after=', gán null vào next\n     // if ($node[\"Get Id Store3\"]?.json?.data && $node[\"Get Id Store3\"].json.data.length > 0) {\n     //  item.json.conver = $node[\"Get Id Store3\"]?.json?.data[0]?.id;\n     // }\n  }\n}\n\nreturn $input.all();"
      },
      "id": "66e07d5a-a06a-403e-ab2c-5b885155c3cd",
      "name": "Take Page Next3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "return null;"
      },
      "id": "32b8889a-010f-4f57-956c-d5d7e3c2dd2e",
      "name": "Code2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        840,
        640
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": 1945469018,
          "mode": "list",
          "cachedResultName": "client_message",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit#gid=1945469018"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "conversation_id": "={{ $json.id }}",
            "update_time": "={{ $json.updated_time }}"
          },
          "matchingColumns": [
            "conversation_id"
          ],
          "schema": [
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "update_time",
              "displayName": "update_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "id_message",
              "displayName": "id_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ]
        },
        "options": {}
      },
      "id": "4f70eea9-44da-4d31-8e42-d543361b609b",
      "name": "Save messaage6",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        760,
        400
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Vl0s1SHrC6Hdk8iv",
          "name": "Canh Google Sheets "
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "data",
        "options": {}
      },
      "id": "25d2e540-3840-4481-a268-14ef86e66cbe",
      "name": "Split Out2",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        520,
        400
      ]
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "id": "d64cf649-0ad8-4050-8dbc-460d9861cd61",
      "name": "Merge3",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1080,
        460
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": 1945469018,
          "mode": "list",
          "cachedResultName": "client_message",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit#gid=1945469018"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "specifyRangeA1",
              "range": "2:10"
            }
          }
        }
      },
      "id": "d10ec481-9ac9-4286-8b37-dcb5e0c4d525",
      "name": "Save messaage",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        960,
        1000
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Vl0s1SHrC6Hdk8iv",
          "name": "Canh Google Sheets "
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": 1945469018,
          "mode": "list",
          "cachedResultName": "client_message",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit#gid=1945469018"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "conversation_id": "={{ $json.id }}",
            "id_client_message": "={{ $json.participants.data[0].id }}",
            "name_client_facebook": "={{ $json.participants.data[0].name }}",
            "email_client_facebook": "={{ $json.participants.data[0].email }}"
          },
          "matchingColumns": [
            "conversation_id"
          ],
          "schema": [
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "update_time",
              "displayName": "update_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_client_message",
              "displayName": "id_client_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "name_client_facebook",
              "displayName": "name_client_facebook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "email_client_facebook",
              "displayName": "email_client_facebook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ]
        },
        "options": {}
      },
      "id": "42dea857-c52d-4473-bbcb-2ce6584e3263",
      "name": "Save messaage1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        1620,
        480
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Vl0s1SHrC6Hdk8iv",
          "name": "Canh Google Sheets "
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "cd73e357-97cc-40e1-8247-0e9a29785a0a",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1180,
        1000
      ]
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v21.0/{{ $('Get Id Store2').item.json.data[0].id }}/messages",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "access_token",
              "value": "EAAQEYCcZCVQ0BOzY6wqcnJVxVynZBLbm5hhScnbluyUZAfGFji6VNyf3R8Jvy0zDoypmZBIsFhZCU1tBRPjlIwS1FWFDeDSqzSa2AGdyDqbTN7MP88cbSiP9CPXY1gmM4EJzHWsO64oZBZA8bimm01LQ3p0n5jCpZCzhjlESwV0JGm16ocyrZBLHu9FSh5wYe08wZD"
            },
            {
              "name": "fields",
              "value": "messages{id,message,from,to}"
            },
            {
              "name": "limit",
              "value": "25"
            },
            {
              "name": "after",
              "value": "={{ $json.next }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "751e4c3d-c2f4-4ce0-a654-1bd9730d4c65",
      "name": "Get Detail list Chat User6",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1680,
        1020
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.next }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "0a696885-d139-4dbf-8619-052a86b44dc6",
      "name": "IF7",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2040,
        1120
      ]
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  const after = item?.json?.paging?.next;\n  console.log('after', after);\n\n  if (after && after.includes(\"after=\")) {\n    const valueAfterEqual = after.split(\"after=\")[1];\n    item.json.next = valueAfterEqual;\n\n    //Kiểm tra dữ liệu trả về từ Get Id Store\n    if ($node[\"Get Id Store2\"]?.json?.data && $node[\"Get Id Store2\"].json.data.length > 0) {\n      item.json.conver = $node[\"Get Id Store2\"]?.json?.data[0]?.id; // Lấy ID từ data[0]\n    } else {\n      console.log('No data found in Get Id Store');\n    }\n  } else {\n    item.json.next = null; // Nếu không có 'after=', gán null vào next\n     if ($node[\"Get Id Store2\"]?.json?.data && $node[\"Get Id Store2\"].json.data.length > 0) {\n      item.json.conver = $node[\"Get Id Store2\"]?.json?.data[0]?.id;\n     }\n  }\n}\n\nreturn $input.all();"
      },
      "id": "a1ef3a0d-3692-4c73-9c3e-7fc18c8f08db",
      "name": "Take Page Next2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1860,
        1020
      ]
    },
    {
      "parameters": {
        "jsCode": "return null;"
      },
      "id": "545f2361-19b6-416a-9af6-12cff1a23529",
      "name": "Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2280,
        1140
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "fieldsToAggregate": {
          "fieldToAggregate": [
            {
              "fieldToAggregate": "data"
            }
          ]
        },
        "options": {}
      },
      "id": "6f94c3a8-47ce-4d8b-9c2c-1e54f16907c4",
      "name": "Aggregate5",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        2620,
        1020
      ]
    },
    {
      "parameters": {
        "jsCode": "const listMessages = $node['Aggregate6']?.json?.data\nlet document =''\ndocument+='List Messages sent by client with admin: \\n'\nfor (const item of listMessages.reverse()) {\n  document+= `${item?.from?.id == 112710510078308 ? 'Admin send: ' : 'Client sent: '} ${item?.message} \\n\\n`\n}\n\ndocument+=`\\n\\n Last message sent by client: ${listMessages[listMessages.length-1].message}`\nconsole.log(document)\nreturn {messagesSent: document};"
      },
      "id": "1a1f2e96-c830-45a6-9eca-6cd6bcd3ea9c",
      "name": "Get All Messages3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3420,
        1020
      ]
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v21.0/{{ $json.id }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "access_token",
              "value": "EAAQEYCcZCVQ0BOzY6wqcnJVxVynZBLbm5hhScnbluyUZAfGFji6VNyf3R8Jvy0zDoypmZBIsFhZCU1tBRPjlIwS1FWFDeDSqzSa2AGdyDqbTN7MP88cbSiP9CPXY1gmM4EJzHWsO64oZBZA8bimm01LQ3p0n5jCpZCzhjlESwV0JGm16ocyrZBLHu9FSh5wYe08wZD"
            },
            {
              "name": "fields",
              "value": "id,message,from,to"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "8218da73-f895-47ee-88e1-8c223f534c39",
      "name": "Get messages according to id2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3020,
        1020
      ]
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "=data",
        "options": {}
      },
      "id": "85925f9a-8c6a-4424-8c44-be64cc69b7b8",
      "name": "Aggregate6",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        3220,
        1020
      ]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": 1620310761,
          "mode": "list",
          "cachedResultName": "get_message",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit#gid=1620310761"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ]
        },
        "options": {}
      },
      "id": "4edc8dfb-da98-4656-92e5-c2bc68d8595e",
      "name": "Save messaage2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        2220,
        920
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Vl0s1SHrC6Hdk8iv",
          "name": "Canh Google Sheets "
        }
      }
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "id": "09ffe2e0-d290-4c6b-ad96-7b8eb0b5c907",
      "name": "Merge2",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        2440,
        1020
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "=https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": 1620310761,
          "mode": "list",
          "cachedResultName": "get_message",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit#gid=1620310761"
        },
        "options": {}
      },
      "id": "219281c9-3663-41a1-93a2-8c2e3a936476",
      "name": "Save messaage5",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        2820,
        1020
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Vl0s1SHrC6Hdk8iv",
          "name": "Canh Google Sheets "
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "data",
        "options": {}
      },
      "id": "b4548b12-b4f8-4fd4-8989-85c073e305ca",
      "name": "Split Out1",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        2060,
        920
      ]
    },
    {
      "parameters": {
        "url": "https://graph.facebook.com/v21.0/112710510078308/conversations",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "platform",
              "value": "MESSENGER"
            },
            {
              "name": "user_id",
              "value": "={{ $json['8949801145114159'] }}"
            },
            {
              "name": "access_token",
              "value": "EAAQEYCcZCVQ0BOzY6wqcnJVxVynZBLbm5hhScnbluyUZAfGFji6VNyf3R8Jvy0zDoypmZBIsFhZCU1tBRPjlIwS1FWFDeDSqzSa2AGdyDqbTN7MP88cbSiP9CPXY1gmM4EJzHWsO64oZBZA8bimm01LQ3p0n5jCpZCzhjlESwV0JGm16ocyrZBLHu9FSh5wYe08wZD"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "3b0ba904-dd28-4191-9e61-895ef3a2d6df",
      "name": "Get Id Store2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1440,
        1020
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "documentId": {
          "__rl": true,
          "value": "=https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": 1466582400,
          "mode": "list",
          "cachedResultName": "Message Facebook",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit#gid=1466582400"
        },
        "numberToDelete": 200
      },
      "id": "448a55cc-1b5c-4ade-a511-347938adf28a",
      "name": "Delete message2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        3800,
        680
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Vl0s1SHrC6Hdk8iv",
          "name": "Canh Google Sheets "
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let emails = []; // Mảng để lưu trữ các email tìm được\n\n// Lặp qua tất cả các phần tử trong $input\nfor (const item of $input.all()) {\n  const messagesSent = item.json.messagesSent;\n\n  // Sử dụng biểu thức chính quy để tìm email trong messagesSent\n  const emailRegex = /\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\b/g;\n  \n  // Tìm tất cả email trong messagesSent và thêm vào mảng emails\n  const foundEmails = messagesSent.match(emailRegex);\n  if (foundEmails) {\n    emails.push(...foundEmails); // Thêm các email tìm được vào mảng emails\n  }\n}\n\nconsole.log('Found Emails:', emails); // Hiển thị các email đã tìm được\n\n// Trả về một cột mới chứa các email tìm được\nreturn { emails: emails };"
      },
      "id": "3580ca25-ca9c-4660-9f7e-d192335f8b48",
      "name": "Get email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3640,
        1020
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "503a0d24-a1dd-4de0-a341-943d8e1d5f81",
              "leftValue": "={{ $json.emails }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "194d890d-36d0-4afc-b540-d7af548648ae",
      "name": "If",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3380,
        600
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.emails.length === 1 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "one mail"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8f44a949-d11f-4bb8-83b3-e73ada99c071",
                    "leftValue": "={{ $json.emails.length > 1 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "many mail"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9ff16d8f-7fd9-4e5d-b0b0-7d982949c70d",
                    "leftValue": "={{ $json.emails.length === 0 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "no mail"
            }
          ]
        },
        "options": {}
      },
      "id": "e8911661-5abe-4369-8500-7d0cf03dd7bd",
      "name": "Switch mail",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3840,
        1020
      ]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": 1945469018,
          "mode": "list",
          "cachedResultName": "client_message",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1lM_TG2ExLdbs1YoBcaFzBFscVqB3MOEFjBFnvE9kAa0/edit#gid=1945469018"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "status": "No email",
            "conversation_id": "={{ $('Get Id Store2').item.json.data[0].id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "update_time",
              "displayName": "update_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_client_message",
              "displayName": "id_client_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "name_client_facebook",
              "displayName": "name_client_facebook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "email_client_facebook",
              "displayName": "email_client_facebook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "1c305ab9-ef27-4759-9679-e9ab90731768",
      "name": "update email",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        4160,
        1280
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Vl0s1SHrC6Hdk8iv",
          "name": "Canh Google Sheets "
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Get Detail list Chat User2": {
      "main": [
        [
          {
            "node": "Get Detail Last list Chat User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Get Detail list Chat User2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Test workflow’": {
      "main": [
        [
          {
            "node": "Save messaage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All conversation": {
      "main": [
        [
          {
            "node": "Take Page Next3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF8": {
      "main": [
        [
          {
            "node": "Get All conversation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Take Page Next3": {
      "main": [
        [
          {
            "node": "IF8",
            "type": "main",
            "index": 0
          },
          {
            "node": "Split Out2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Save messaage6": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out2": {
      "main": [
        [
          {
            "node": "Save messaage6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save messaage": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Save messaage1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Get Id Store2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Detail list Chat User6": {
      "main": [
        [
          {
            "node": "Take Page Next2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF7": {
      "main": [
        [
          {
            "node": "Get Detail list Chat User6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Take Page Next2": {
      "main": [
        [
          {
            "node": "IF7",
            "type": "main",
            "index": 0
          },
          {
            "node": "Split Out1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Aggregate5": {
      "main": [
        [
          {
            "node": "Save messaage5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get messages according to id2": {
      "main": [
        [
          {
            "node": "Aggregate6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate6": {
      "main": [
        [
          {
            "node": "Get All Messages3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save messaage2": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Aggregate5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save messaage5": {
      "main": [
        [
          {
            "node": "Get messages according to id2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out1": {
      "main": [
        [
          {
            "node": "Save messaage2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Id Store2": {
      "main": [
        [
          {
            "node": "Get Detail list Chat User6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Messages3": {
      "main": [
        [
          {
            "node": "Get email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get email": {
      "main": [
        [
          {
            "node": "Switch mail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch mail": {
      "main": [
        [],
        [],
        [
          {
            "node": "update email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ff68106b-a2c7-4c9b-825e-33d33ff93844",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "3909475c03ca6926b6e6edc6a6f06c1feb448ce7ac700d69b17002085d9011f8"
  },
  "id": "Dn3iQJdCFaBj5lJW",
  "tags": []
}